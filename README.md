# מערכת שיבוץ מבצעית 2026 - גרסה משופרת 🚀

מערכת מתקדמת לניהול ושיבוץ משמרות עובדים עם ממשק RTL, חיבור Firebase ואלגוריתמים אוטומטיים.

## ✨ שיפורים בגרסה החדשה

### 🛡️ אמינות ואבטחה
- ✅ טיפול מלא בשגיאות עם הודעות ברורות
- ✅ ולידציה מקיפה של קבצי קלט
- ✅ הגנה מפני HTML injection
- ✅ טיפול בפורמטים שונים של תאריכים
- ✅ בדיקת עמודות נדרשות לפני עיבוד

### ⚡ ביצועים
- ✅ Caching של שאילתות Firebase (60 שניות)
- ✅ אופטימיזציה של אלגוריתם השיבוץ
- ✅ Batch operations ל-Firebase

### 📊 פיצ'רים חדשים
- ✅ סטטיסטיקות בזמן אמת
- ✅ ייצוא לאקסל/CSV
- ✅ מדדי השלמה ומעקב
- ✅ לוגים מפורטים למעקב אחר פעולות
- ✅ הוראות שימוש משולבות

### 🎨 ממשק משתמש
- ✅ עיצוב משופר עם גרדיאנטים
- ✅ הודעות ברורות ומועילות
- ✅ אייקונים אינטואיטיביים
- ✅ תמיכה מלאה ב-RTL

### 🔧 קוד נקי
- ✅ ארגון קוד לפי פונקציונליות
- ✅ Type hints לכל הפונקציות
- ✅ Docstrings מפורטים
- ✅ הפרדת לוגיקה מממשק

---

## 📋 דרישות מערכת

- Python 3.8+
- חשבון Firebase עם Firestore
- דפדפן מודרני (Chrome, Firefox, Edge)

---

## 🚀 התקנה

### 1. שכפול הפרויקט
```bash
git clone <repository-url>
cd opp-system
```

### 2. התקנת תלויות
```bash
pip install -r requirements.txt
```

### 3. הגדרת Firebase

#### א. יצירת פרויקט Firebase:
1. היכנס ל-https://console.firebase.google.com
2. צור פרויקט חדש
3. הפעל Firestore Database
4. צור Service Account:
   - Settings → Service Accounts
   - Generate New Private Key
   - שמור את קובץ ה-JSON

#### ב. הגדרת Secrets ב-Streamlit:
צור קובץ `.streamlit/secrets.toml`:
```toml
[firebase]
type = "service_account"
project_id = "your-project-id"
private_key_id = "your-private-key-id"
private_key = "-----BEGIN PRIVATE KEY-----\nYour-Private-Key\n-----END PRIVATE KEY-----\n"
client_email = "your-service-account@project.iam.gserviceaccount.com"
client_id = "your-client-id"
auth_uri = "https://accounts.google.com/o/oauth2/auth"
token_uri = "https://oauth2.googleapis.com/token"
auth_provider_x509_cert_url = "https://www.googleapis.com/oauth2/v1/certs"
client_x509_cert_url = "your-cert-url"
```

### 4. הרצת האפליקציה
```bash
streamlit run opp_improved.py
```

האפליקציה תיפתח אוטומטית בדפדפן בכתובת: http://localhost:8501

---

## 📁 פורמט קבצי קלט

### קובץ בקשות עובדים (`requests.csv`)
```csv
שם,תאריך מבוקש,משמרת,תחנה,אט"ן מורשה
יוסי כהן,01/03/2026,בוקר,תחנה א,כן
מרים לוי,01/03/2026,ערב,תחנה ב,לא
...
```

**עמודות חובה:**
- `שם` - שם העובד
- `תאריך מבוקש` - בפורמט DD/MM/YYYY
- `משמרת` - סוג המשמרת (בוקר/ערב/לילה)
- `תחנה` - שם התחנה

**עמודות אופציונליות:**
- `אט"ן מורשה` - כן/לא (לסינון משמרות אט"ן)

### תבנית משמרות (`shifts.csv`)
```csv
תחנה,משמרת,סוג תקן
תחנה א,בוקר,רגיל
תחנה א,ערב,אט"ן
תחנה ב,לילה,רגיל
...
```

**עמודות חובה:**
- `תחנה` - שם התחנה
- `משמרת` - סוג המשמרת
- `סוג תקן` - רגיל/אט"ן

---

## 🎯 הוראות שימוש

### שלב 1: העלאת קבצים
1. בצד ימין, לחץ על "קובץ בקשות עובדים"
2. בחר את קובץ ה-CSV עם הבקשות
3. לחץ על "תבנית משמרות"
4. בחר את קובץ ה-CSV עם המשמרות

### שלב 2: שיבוץ אוטומטי
1. לחץ על כפתור "🪄 שיבוץ אוטומטי"
2. המערכת תשבץ עובדים אוטומטית לפי:
   - זמינות בבקשות
   - מאזן משמרות (מי עבד הכי פחות)
   - התאמה לסוג משמרת (אט"ן/רגיל)

### שלב 3: שיבוץ ידני (אופציונלי)
1. לחץ "➕ שבץ" על משמרת ריקה
2. בחר עובד מהרשימה המסוננת
3. לחץ "✅ אישור"

### שלב 4: ניהול שיבוצים
- **הסרת שיבוץ:** לחץ "🗑️ הסר"
- **עריכת שיבוץ:** לחץ "✏️"
- **ביטול משמרת:** לחץ "🚫"
- **שחזור משמרת:** לחץ "🔄 שחזר"

### שלב 5: שמירה
1. לחץ "💾 שמירה ל-Database" - שומר ל-Firebase
2. או "📥 ייצוא לאקסל" - מוריד קובץ CSV

---

## 🗂️ מבנה Database (Firestore)

### Collections:

#### `assignments`
```javascript
{
  "2026-03-01_תחנה-א_בוקר_0": {
    "employee": "יוסי כהן",
    "date": "01/03/2026",
    "station": "תחנה א",
    "shift": "בוקר",
    "timestamp": Timestamp
  }
}
```

#### `employee_history`
```javascript
{
  "יוסי כהן": {
    "total_shifts": 15,
    "last_updated": Timestamp
  }
}
```

---

## 🐛 פתרון בעיות נפוצות

### שגיאה: "חסרים פרטי התחברות ל-Firebase"
**פתרון:** ודא שקובץ `.streamlit/secrets.toml` קיים ומכיל את כל הפרטים הנדרשים.

### שגיאה: "עמודות חסרות בקובץ"
**פתרון:** ודא שקבצי ה-CSV כוללים את כל העמודות הנדרשות (ראה פורמט קבצים).

### שגיאה: "פורמט תאריך לא תקין"
**פתרון:** ודא שהתאריכים בפורמט DD/MM/YYYY (למשל: 01/03/2026).

### המערכת איטית
**פתרון:** 
- בדוק חיבור אינטרנט (Firebase)
- הקטן את מספר השורות בקבצים לבדיקה
- נקה cache: לחץ 'C' בדפדפן

---

## 📊 אלגוריתם השיבוץ

```
לכל תאריך:
  לכל משמרת:
    1. מצא עובדים שביקשו תאריך זה
    2. סנן לפי משמרת ותחנה
    3. הסר עובדים שכבר שובצו היום
    4. אם משמרת אט"ן - סנן רק מורשים
    5. מיין לפי מאזן משמרות (עולה)
    6. שבץ את מי שעבד הכי פחות
    7. עדכן מאזן
```

**יתרונות:**
- ✅ חלוקה הוגנת של משמרות
- ✅ מניעת כפל שיבוץ ביום
- ✅ התחשבות בהסמכות אט"ן
- ✅ עדכון מאזן בזמן אמת

---

## 🔐 אבטחה

- ✅ כל הקלטים מנוקים מ-HTML injection
- ✅ פרטי Firebase מאובטחים ב-secrets
- ✅ אין חשיפת מידע רגיש בלוגים
- ✅ ולידציה של כל הקלטים

---

## 📝 לוגים

הלוגים נשמרים ב-console ומכילים:
- `INFO`: פעולות רגילות (שמירה, שיבוץ)
- `WARNING`: בעיות לא קריטיות
- `ERROR`: שגיאות שדורשות תשומת לב

להצגת לוגים:
```bash
streamlit run opp_improved.py 2>&1 | tee app.log
```

---

## 🆘 תמיכה

לשאלות או בעיות:
1. בדוק את סעיף "פתרון בעיות"
2. בדוק את הלוגים
3. צור issue בגיטהאב

---

## 📜 רישיון

MIT License - ראה LICENSE file

---

## 🙏 תודות

נבנה עם:
- [Streamlit](https://streamlit.io) - פריימוורק ה-UI
- [Firebase](https://firebase.google.com) - Database ו-Backend
- [Pandas](https://pandas.pydata.org) - עיבוד נתונים

---

## 📈 גרסאות

### v2.0 (נוכחית)
- ✨ שיפורים מקיפים באמינות וביצועים
- ✨ ממשק משופר עם סטטיסטיקות
- ✨ תמיכה בייצוא
- ✨ לוגים ומעקב

### v1.0
- ✅ גרסה בסיסית עם שיבוץ אוטומטי
- ✅ ממשק RTL
- ✅ חיבור Firebase

---

**Built with ❤️ for efficient shift management**
